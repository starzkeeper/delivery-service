# Описание проекта

Основная идея проекта заключается в реализации сервиса, позволяющего любому, даже самому маленькому магазину предоставить возможность
в несколько кликов создать сервис доставки,а так же любому желающему человеку, в любой момент стать курьером у ближайших
магазинов. Магазину будет доступна удобная система массовой загрузки товаров и продвинутая система отчетов по продажам.

Реализуется система моментальной регистрации курьеров, всё что нужно - зайти в телеграм бота, отправить трансляцию местоположения,
и получить ближайший заказ.(Продумывается система защиты от недобросовестных курьеров)

Для клиентов доставки создаётся система трекинга заказов, которая показывает актуальное состояние заказа в real-time и позволяет рассчитывать
время, через которое заказ прибудет, а так же отслеживать местоположение курьера.

Для админов вебсокет соединение для отслеживания местоположения курьеров

# Запуск проекта

Для запуска необходим Docker

1. Склонировать репозиторий
```
git clone https://github.com/murekswork/velociped
```
2. Перейти в директорию проекта
```
cd velociped/backend
```
3. Запустить контейнеры
```
docker compose up --build 
```
4. Добавить топик в кафку: дождаться запуска кафки и в отдельном терминале ввести
```
docker compose exec kafka sh
kafka-topics --create --zookeeper zookeeper:2181 --topic __consumer_offsets --replication-factor 1 --partitions 50
```


## Функционал

На данный момент, в проекте реализован следующий функционал:
- CRUD-функционал для работы с основными сущностями
- Сервис валидации загружаемых данных
- Гибкая система permission-ов
- Поиск товаров
- Система скидок, заказов и отзывов
- Ведется разработка системы периодических отчетов по продажам для магазинов
- Создано курьерское приложения на базе телеграм бота.
- Реализована регистрация курьеров и система трекинга их действий
- Распределение заказов между свободными курьерами, учитывающее расстояние от курьера до точек заказ и приоритет заказа
- Синхронизация состояния заказа между курьерским сервисом и базой данных
- Уведомления об опозданиях по доставке для курьеров
- Периодический расчет показаталей средней скорости курьеров, основанный на доставленных заказах
- Вебсокет соединение для отслеживания курьеров

## Сущности

### Магазин

Для управления магазином реализована логика управления permission-ами. Владелец магазина может создавать менеджеров, которых можно наделять различными правами.
#### TODO: Реализовать систему для слежения об актуальных заказах для магазина.

### Продукт

Реализована логика валидации каждого продукта. Проверка на содержание запрещенных слов и другие аспекты.

### Заказ

Реализована mock система оплаты и многоступенчатая система валидации заказа перед оплатой.

### Доставка
Реализована система передачи сохраненной доставки в курьерское приложение и ее назначение ближайшему свободному курьеру.
Все изменения состояния в процессе доставки передаются от курьерского приложения к клиентскому для удобства отслеживания.

При обнаружении возможного опоздания доставки высылается уведомление курьеру с просьбой поторопиться.

### Курьер

На данный момент есть сырая реализация регистрации в боте, трекинга местоположения, выхода на линию, получения заказ,
завершения заказа с получением награды, выхода с линии.

При активации бота для курьера автоматически создаётся профиль в базе данных. При выходе на линию система подбирает заказ
для курьера, отталкиваюсь от его текущего местоположения. При успешном завершении заказа начисляется награда.

При назначении курьеру доставки высылается сообщение с координатами где нужно забрать заказ и высылается сообщение с обновлением статуса заказа на
клиентский сервис, после отметки о получении заказа высылается сообщение с координатами куда нужно отнести заказ, повторно высылается сообщение с обновлением статуса заказа.

При нажатии кнопки "забрал" или "доставил" происходит проверка местоположения курьера и местоположения точки доставки.

## Инфраструктура

Для разворачивания инфраструктуры приложения используется Docker Compose
Для ускорение процесса разработки написан Makefile со скриптами часто используемых сценариев

### Связь сервисов

- Kafka, Zookeeper - для общения между сервисом маркетплейса и службой доставки: получение данных о состоянии заказа, информации о курьере
и real-time трекинг передвижений.

### Хранилища

- PostgreSQL - основная база данных
- Redis - для кеша и в качестве брокера для Celery

### Фоновые задачи

- Celery - для выполнения сложных задач приложения. Многие операции, которые потенциально могут нести высокие
нагрузки выведены в бэкграунд.

### Курьерское приложение

- Телеграм бот - обеспечивает очень удобную и быструю процедуру регистрации в качестве курьера для любого желающего заработать, а также
удобный инструмент для отслеживания действий курьеров.

## Стиль написания

При разработке придерживаюсь best-practise в разработке REST API, использую шаблоны проектирования и следую принципам SOLID, DRY, KISS.
Настроены pre-commit хуки, линтеры для поддержания единообразия кода и обнаружения ошибок на ранних этапах разработки.

## Оптимизация

Проводится оптимизация SQL запросов.
Исправлены n+1 ошибки, исправлено избытычное обращение к базе данных.

## Тестирование

Написание кода ведется с учетом TDD, каждая логическая строка кода сначала покрывается юнит тестами.

### Тестирование загрузки товаров для магазина
- На данный момент проведено тестирование в условиях загрузки таблицы со 100000 продуктов и
валидацией каждого из продуктов - клиент не заметил никаких изменений в работе приложения. (В дальнейшем планируется автоматизация
повышения выделяемых ресурсов и количества worker-ов при увелечении нагрузок на сервис)
